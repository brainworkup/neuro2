# Domain Generation Module
# Handles generating domain-specific QMD files

#' Generate Workflow Domains
#'
#' @param config Configuration list from .load_workflow_config
#' @return Logical indicating success
#' @export
generate_workflow_domains <- function(config) {
  # workflow_utils functions are available through neuro2 package
  # workflow_data_processor functions are available through neuro2 package

  log_message("Generating domain files...", "WORKFLOW")

  # Determine patient type
  patient_type <- .determine_patient_type(config$patient$age)
  log_message(paste("Determined patient type:", patient_type), "DOMAINS")

  # Check for required R6 classes
  if (!.check_domain_r6_files()) {
    log_message("Will use fallback domain generation method", "WARNING")
    return(.run_fallback_domain_generation(config, patient_type))
  }

  # Check if data exists
  data_status <- .check_data_exists(config)
  if (!data_status$neurocog) {
    log_message("No neurocog data files found", "DOMAINS")
    return(.run_fallback_domain_generation(config, patient_type))
  }

  # Load R6 classes
  .load_domain_r6_classes()

  # Process domains
  success <- process_all_domains(config, patient_type, data_status)

  log_message("Domain generation complete", "DOMAINS")
  return(success)
}

.check_domain_r6_files <- function() {
  # workflow_utils functions are available through neuro2 package

  log_message(
    "Checking for required R6 classes for domain processing...",
    "DOMAINS"
  )

  r6_domain_files <- c(
    "R/NeuropsychResultsR6.R",
    "R/DomainProcessorR6.R",
    "R/TableGTR6.R",
    "R/DotplotR6.R"
  )

  missing_r6_files <- r6_domain_files[!file.exists(r6_domain_files)]

  if (length(missing_r6_files) > 0) {
    log_message("Some required R6 class files are missing:", "WARNING")
    for (file in missing_r6_files) {
      log_message(paste0("  - ", file), "WARNING")
    }
    return(FALSE)
  }

  log_message(
    "All required R6 class files for domain processing are present",
    "DOMAINS"
  )
  return(TRUE)
}

.load_domain_r6_classes <- function() {
  # R6 classes are available through the neuro2 package namespace
  # No need to source them individually
}

# Replace your current domain processing with this approach:

#' Process domains using the factory pattern
#' @param config Configuration object from workflow
#' @param patient_type "adult" or "child"
#' @param data_status Data availability status
process_all_domains <- function(config, patient_type, data_status) {
  # Setup environment
  # Use require() or check if object exists instead
  # FIXED: source(here::here("R", "setup_neuro2.R")) # Moved to lazy loading
  setup_neuro2()

  # Create factory
  factory <- DomainProcessorFactoryR6$new()

  # Define domain keys based on typical neuropsychological domains
  domain_keys <- c(
    "iq",
    "academics",
    "verbal",
    "spatial",
    "memory",
    "executive",
    "motor",
    "social",
    "adhd",
    "emotion",
    "adaptive",
    "daily_living"
  )

  # Validate domains have data first
  valid_domains <- c()
  for (domain_key in domain_keys) {
    validation <- factory$validate_domain_data(domain_key, detailed = TRUE)
    if (validation$valid) {
      valid_domains <- c(valid_domains, domain_key)
      message(paste("✅", domain_key, "has data"))
    } else {
      message(paste("❌", domain_key, "skipped:", validation$details$error))
    }
  }

  if (length(valid_domains) == 0) {
    stop("No valid domains found with data")
  }

  # Process each valid domain
  results <- list()

  for (domain_key in valid_domains) {
    message(paste("\n📊 Processing", domain_key, "..."))

    # Get domain config
    config_obj <- factory$get_processor_config(domain_key)

    if (is.null(config_obj)) {
      message(paste("❌ No configuration for", domain_key))
      next
    }

    # Check if multi-rater
    if (config_obj$multi_rater) {
      processors <- factory$create_multi_processor(domain_key, patient_type)
      if (!is.null(processors)) {
        for (rater in names(processors)) {
          processor <- processors[[rater]]
          result <- tryCatch(
            {
              processor$process(generate_domain_files = TRUE)
              message(paste("  ✅", rater, "processed successfully"))
              processor
            },
            error = function(e) {
              message(paste("  ❌", rater, "failed:", e$message))
              NULL
            }
          )
          results[[paste(domain_key, rater, sep = "_")]] <- result
        }
      }
    } else {
      # Single rater domain
      processor <- factory$create_processor(domain_key, patient_type)
      if (!is.null(processor)) {
        result <- tryCatch(
          {
            processor$process(generate_domain_files = TRUE)
            message(paste("  ✅", domain_key, "processed successfully"))
            processor
          },
          error = function(e) {
            message(paste("  ❌", domain_key, "failed:", e$message))
            NULL
          }
        )
        results[[domain_key]] <- result
      }
    }
  }

  return(length(results) > 0)
}

# Example usage:
# results <- process_all_domains(
#   domain_keys = c("iq", "memory", "executive", "emotion", "adhd"),
#   age_group = "child"
# )

# process_all_domains_old <- function(config, patient_type, data_status) {
#   # This is an old version of the function - kept for reference
#   # The current active function is process_all_domains above
# }

# Validated domain processing functions
.process_single_domain_validated <- function(
  domain_name,
  config,
  neurocog_data,
  neurobehav_data
) {
  log_message(paste("Validating domain:", domain_name), "DOMAINS")

  # Determine data source
  data_source <- if (grepl("neurocog", config$input_file)) {
    neurocog_data
  } else {
    neurobehav_data
  }

  # Validate data exists BEFORE processing
  validation <- .validate_domain_data_exists(domain_name, data_source)

  if (!validation$has_data) {
    log_message(
      paste("Skipping", domain_name, "-", validation$message),
      "DOMAINS"
    )
    return(FALSE)
  }

  log_message(
    paste(
      "Processing domain:",
      domain_name,
      "- has",
      validation$row_count,
      "rows"
    ),
    "DOMAINS"
  )

  # Proceed with processing only if data exists
  tryCatch(
    {
      processor <- DomainProcessorR6$new(
        domains = domain_name,
        pheno = config$pheno,
        input_file = config$input_file
      )

      # Load and validate data again in processor
      processor$load_data()
      processor$filter_by_domain()

      if (is.null(processor$data) || nrow(processor$data) == 0) {
        log_message(
          paste("No valid data after filtering for:", domain_name),
          "WARNING"
        )
        return(FALSE)
      }

      # Generate domain files
      generated_file <- processor$generate_domain_qmd()
      log_message(paste("Generated:", generated_file), "DOMAINS")

      # Generate text files
      processor$generate_domain_text_qmd()

      return(TRUE)
    },
    error = function(e) {
      log_message(
        paste("Error processing domain", domain_name, ":", e$message),
        "ERROR"
      )
      return(FALSE)
    }
  )
}

# Validated emotion domain processing
.process_emotion_domains_validated <- function(
  is_child,
  emotion_domains,
  neurobehav_data
) {
  # Check which emotion domains have data
  emotion_domains_present <- c()
  combined_validation <- list(row_count = 0, has_data = FALSE)

  for (domain_name in emotion_domains) {
    validation <- .validate_domain_data_exists(domain_name, neurobehav_data)
    if (validation$has_data) {
      emotion_domains_present <- c(emotion_domains_present, domain_name)
      combined_validation$row_count <- combined_validation$row_count +
        validation$row_count
      combined_validation$has_data <- TRUE
    }
  }

  if (!combined_validation$has_data) {
    log_message("No emotion domains have data - skipping", "DOMAINS")
    return(FALSE)
  }

  tryCatch(
    {
      age_type <- if (is_child) "child" else "adult"
      log_message(
        paste(
          "Processing",
          combined_validation$row_count,
          "emotion records for",
          age_type
        ),
        "DOMAINS"
      )

      processor <- DomainProcessorR6$new(
        domains = emotion_domains_present,
        pheno = "emotion",
        input_file = "data/neurobehav.parquet"
      )

      processor$load_data()
      processor$filter_by_domain()

      if (!is.null(processor$data) && nrow(processor$data) > 0) {
        processor$select_columns()
        processor$save_data()

        # FIXED: Use the updated generate_domain_qmd method
        # The method automatically detects child vs adult emotion type
        generated_file <- processor$generate_domain_qmd(
          domain_name = emotion_domains_present[1] # Use first domain as name
        )
        log_message(paste("Generated:", generated_file), "DOMAINS")

        return(TRUE)
      }

      return(FALSE)
    },
    error = function(e) {
      log_message(
        paste("Error processing emotion domains:", e$message),
        "ERROR"
      )
      return(FALSE)
    }
  )
}

# Validated ADHD domain processing
.process_adhd_domain_validated <- function(is_child, neurobehav_data) {
  validation <- .validate_domain_data_exists("ADHD", neurobehav_data)

  if (!validation$has_data) {
    log_message("No ADHD data found - skipping", "DOMAINS")
    return(FALSE)
  }

  tryCatch(
    {
      age_type <- if (is_child) "child" else "adult"
      log_message(
        paste("Processing", validation$row_count, "ADHD records for", age_type),
        "DOMAINS"
      )

      processor <- DomainProcessorR6$new(
        domains = "ADHD",
        pheno = "adhd",
        input_file = "data/neurobehav.parquet"
      )

      processor$load_data()
      processor$filter_by_domain()

      if (!is.null(processor$data) && nrow(processor$data) > 0) {
        processor$select_columns()
        processor$save_data()

        # FIXED: Use the updated generate_domain_qmd method
        # The method automatically detects child vs adult ADHD type
        generated_file <- processor$generate_domain_qmd(domain_name = "ADHD")
        log_message(paste("Generated:", generated_file), "DOMAINS")

        return(TRUE)
      }

      return(FALSE)
    },
    error = function(e) {
      log_message(paste("Error processing ADHD domain:", e$message), "ERROR")
      return(FALSE)
    }
  )
}

process_single_domain <- function(
  domain,
  config,
  patient_type,
  processed_domains,
  emotion_processed,
  data_type = "neurocog"
) {
  # workflow_utils functions are available through neuro2 package

  # Skip if already processed
  if (domain %in% processed_domains) {
    log_message(
      paste0("Skipping already processed domain: ", domain),
      "DOMAINS"
    )
    return(list(
      processed_domains = processed_domains,
      emotion_processed = emotion_processed
    ))
  }

  # Handle emotion domains
  emotion_domains <- c("Emotional/Behavioral/Social/Personality")

  if (domain %in% emotion_domains) {
    if (!emotion_processed) {
      log_message("Processing consolidated emotion domain", "DOMAINS")
      emotion_processed <- TRUE
      processed_domains <- c(processed_domains, emotion_domains)
      domain <- "Emotional/Behavioral/Social/Personality"
    } else {
      log_message(
        paste0(
          "Skipping individual emotion domain: ",
          domain,
          " (already processed as consolidated emotion)"
        ),
        "DOMAINS"
      )
      return(list(
        processed_domains = processed_domains,
        emotion_processed = emotion_processed
      ))
    }
  }

  # Get input file
  input_format <- .get_data_format(config, data_type)
  input_file <- file.path(
    config$data$output_dir,
    paste0(data_type, ".", input_format)
  )

  # Create domain processor
  domain_processor <- DomainProcessorR6$new(
    domains = domain,
    pheno = .domain_to_pheno(domain),
    input_file = input_file,
    output_dir = config$data$output_dir
  )

  # Process the domain
  tryCatch(
    {
      output_file <- .get_domain_output_file(domain, patient_type)

      domain_processor$process(
        generate_reports = TRUE,
        report_types = c("self"),
        generate_domain_files = TRUE
      )

      # Rename generated file if needed
      generated_file <- paste0(
        "_02-",
        domain_processor$get_domain_number(),
        "_",
        tolower(domain_processor$pheno),
        ".qmd"
      )

      if (generated_file != output_file && file.exists(generated_file)) {
        file.rename(generated_file, output_file)
      }

      processed_domains <- c(processed_domains, domain)
      log_message(paste0("Processed domain: ", domain), "DOMAINS")
    },
    error = function(e) {
      log_message(
        paste0("Error processing domain: ", domain, " - ", e$message),
        "ERROR"
      )
      log_message("Will try to continue with other domains", "WARNING")
    }
  )

  return(list(
    processed_domains = processed_domains,
    emotion_processed = emotion_processed
  ))
}

.domain_to_pheno <- function(domain_name) {
  mapping <- list(
    "General Cognitive Ability" = "iq",
    "Academic Skills" = "academics",
    "Verbal/Language" = "verbal",
    "Visual Perception/Construction" = "spatial",
    "Memory" = "memory",
    "Attention/Executive" = "executive",
    "Motor" = "motor",
    "ADHD/Executive Function" = "adhd",
    "Emotional/Behavioral/Social/Personality" = "emotion",
    # Deprecated aliases
    "ADHD" = "adhd",
    "Behavioral/Emotional/Social" = "emotion",
    "Emotional/Behavioral/Personality" = "emotion",
    "Psychiatric Disorders" = "emotion",
    "Personality Disorders" = "emotion",
    "Psychosocial Problems" = "emotion",
    "Substance Use" = "emotion"
  )

  # Check if domain should be combined into emotion
  emotion_domains <- c(
    "Emotional/Behavioral/Social/Personality",
    # Deprecated aliases for backward compatibility
    "Substance Use",
    "Psychosocial Problems",
    "Psychiatric Disorders",
    "Personality Disorders",
    "Emotional/Behavioral/Personality",
    "Behavioral/Emotional/Social"
  )

  if (domain_name %in% emotion_domains) {
    return("emotion")
  }

  # Return mapped value or default
  pheno_value <- mapping[[domain_name]]
  if (is.null(pheno_value)) {
    if (grepl("Behav|Emot|Psych|Social|Substance|Personality", domain_name)) {
      return("emotion")
    }
    pheno_value <- tolower(gsub("[^a-zA-Z0-9]", "_", domain_name))
  }

  return(pheno_value)
}

.get_domain_output_file <- function(domain_name, patient_type) {
  # Basic domain file mapping
  domain_files <- list(
    "General Cognitive Ability" = "_02-01_iq.qmd",
    "Academic Skills" = "_02-02_academics.qmd",
    "Verbal/Language" = "_02-03_verbal.qmd",
    "Visual Perception/Construction" = "_02-04_spatial.qmd",
    "Memory" = "_02-05_memory.qmd",
    "Attention/Executive" = "_02-06_executive.qmd",
    "Motor" = "_02-07_motor.qmd",
    "Social Cognition" = "_02-08_social.qmd",
    "Adaptive Functioning" = "_02-11_adaptive.qmd",
    "Daily Living" = "_02-12_daily_living"
  )

  # Special handling for ADHD
  if (domain_name == "ADHD/Executive Function") {
    if (patient_type == "adult") {
      return("_02-09_adhd.qmd")
    } else {
      return("_02-09_adhd.qmd")
    }
  }

  # Special handling for emotion domains
  emotion_domains <- c(
    "Emotional/Behavioral/Social/Personality",
    "Behavioral/Emotional/Social",
    "Substance Use",
    "Psychosocial Problems",
    "Psychiatric Disorders",
    "Personality Disorders"
  )

  if (domain_name %in% emotion_domains) {
    if (patient_type == "adult") {
      return("_02-10_emotion.qmd")
    } else {
      return("_02-10_emotion.qmd")
    }
  }

  # Return mapped file or create default
  file_name <- domain_files[[domain_name]]
  if (is.null(file_name)) {
    safe_name <- tolower(gsub("[^a-zA-Z0-9]", "_", domain_name))
    file_name <- paste0("_02-", safe_name, ".qmd")
  }

  return(file_name)
}

.list_generated_domain_files <- function() {
  # workflow_utils functions are available through neuro2 package

  domain_files <- list.files(".", pattern = "_02-.*\\.qmd$")
  if (length(domain_files) > 0) {
    log_message("Generated domain files:", "DOMAINS")
    for (file in domain_files) {
      log_message(paste0("  - ", file), "DOMAINS")
    }
  } else {
    log_message("No domain files were generated", "WARNING")
  }
}

.verify_essential_domain_files <- function(patient_type) {
  # Define essential domain files
  essential_files <- c(
    "_02-01_iq.qmd",
    "_02-02_academics.qmd",
    "_02-03_verbal.qmd",
    "_02-04_spatial.qmd",
    "_02-05_memory.qmd",
    "_02-06_executive.qmd",
    "_02-07_motor.qmd"
  )

  # Add patient-type specific files
  if (patient_type == "adult") {
    essential_files <- c(
      essential_files,
      "_02-09_adhd.qmd",
      "_02-10_emotion.qmd"
    )
  } else {
    essential_files <- c(
      essential_files,
      "_02-09_adhd.qmd",
      "_02-10_emotion.qmd"
    )
  }

  # Check existing files
  domain_files_generated <- list.files(".", pattern = "_02-.*\\.qmd$")
  missing_files <- essential_files[!essential_files %in% domain_files_generated]

  if (length(missing_files) > 0) {
    log_message(
      paste(
        "Missing essential domain files:",
        paste(missing_files, collapse = ", ")
      ),
      "DOMAINS"
    )
    return(FALSE)
  }

  return(TRUE)
}

.run_fallback_domain_generation <- function(config, patient_type) {
  # workflow_utils functions are available through neuro2 package

  # Source the domain generator module as a fallback
  if (file.exists("scripts/domain_generator_module.R")) {
    log_message(
      "Running domain_generator_module.R to generate missing files",
      "DOMAINS"
    )
    # Use require() or check if object exists instead
    # FIXED: source("scripts/domain_generator_module.R") # Moved to lazy loading
    return(TRUE)
  }

  # Try other fallback scripts
  if (file.exists("neuro2_r6_update_workflow.R")) {
    log_message("Using neuro2_r6_update_workflow.R", "DOMAINS")
    # Use require() or check if object exists instead
    # FIXED: source("neuro2_R6_update_workflow.R") # Moved to lazy loading
    return(TRUE)
  }

  log_message("No suitable domain generator found", "ERROR")
  return(FALSE)
}
