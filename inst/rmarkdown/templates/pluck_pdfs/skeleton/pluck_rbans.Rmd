---
title: "Create table and csv for RBANS"
params:
  patient: Ethan
  test:
    label: "Test"
    value: rbans
    input: select
    multiple: no
    choices:
      - rbans
      - rbans_a
      - rbans_b
      - rbans_c
      - rbans_d
  test_name:
    label: "Test Name"
    value: "RBANS"
    input: select
    multiple: no
    choices: [RBANS, RBANS Update Form A, RBANS Update Form B, RBANS Update Form C, RBANS Update Form D]
  file:
    label: "No file selected"
    value: file
    input: file
  line_orientation_pct_rank:
    label: "Line orientation percentile"
    value: 13
    input: numeric
  picture_naming_pct_rank:
    label: "picture naming percentile 2"
    value: 37
    input: numeric
  list_recall_pct_rank:
    label: "List recall Percentile 3"
    value: 37
    input: numeric
  list_recognition_pct_rank:
    label: "List recognition Percentile 4"
    value: 63
    input: numeric
  eval: TRUE
output:
  rmdformats::robobook:
    highlight: kate
---

# Data

-   Export raw CSV file from Q-interactive using "download files" or whatever its called

**Note**: If you encounter Java issues with this RMarkdown file, consider using the `process_rbans_data()` function from `pluck_neuropsych_pdfs.R` instead, which provides the same functionality with better error handling:

# Setup

```{r setup, include=F}
# Configure Java environment for RStudio
java_homes <- c(
  "/Library/Java/JavaVirtualMachines/graalvm-community-openjdk-22.0.1+8.1/Contents/Home",
  "/Library/Java/JavaVirtualMachines/openjdk-21.jdk/Contents/Home",
  "/Library/Java/JavaVirtualMachines/openjdk-17.jdk/Contents/Home",
  "/Library/Java/JavaVirtualMachines/openjdk-11.jdk/Contents/Home",
  "/usr/libexec/java_home"
)

# Find working Java installation
java_home <- NULL
for (path in java_homes) {
  if (dir.exists(path) || path == "/usr/libexec/java_home") {
    if (path == "/usr/libexec/java_home") {
      # Try to get system default Java
      tryCatch({
        java_home <- system("/usr/libexec/java_home", intern = TRUE)
        if (dir.exists(java_home)) break
      }, error = function(e) NULL)
    } else if (dir.exists(path)) {
      java_home <- path
      break
    }
  }
}

# Set Java environment if found
if (!is.null(java_home)) {
  Sys.setenv(JAVA_HOME = java_home)
  options(java.parameters = "-Xmx8000m")
  cat("Java configured at:", java_home, "\n")
} else {
  cat("Warning: No Java installation found. Some functions may not work.\n")
}

knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = FALSE,
  eval = TRUE,
  include = TRUE,
  message = FALSE,
  warning = FALSE,
  error = TRUE
)

# Load non-Java dependent libraries first
library(tidyverse)
library(here)
library(magrittr)
library(glue)

# Try to load Java-dependent libraries with error handling
tryCatch({
  library(rJava)
  library(tabulapdf)
  java_available <- TRUE
}, error = function(e) {
  cat("Warning: Java-dependent packages not available:", e$message, "\n")
  cat("Consider using the process_rbans_data() function from pluck_neuropsych_pdfs.R instead.\n")
  java_available <<- FALSE
})

# Load other libraries
suppressPackageStartupMessages({
  if (requireNamespace("shiny", quietly = TRUE)) library(shiny)
  if (requireNamespace("pdftools", quietly = TRUE)) library(pdftools)
  if (requireNamespace("hablar", quietly = TRUE)) library(hablar)
  if (requireNamespace("googledrive", quietly = TRUE)) library(googledrive)
  if (requireNamespace("bwu", quietly = TRUE)) library(bwu)
  if (requireNamespace("NeurotypR", quietly = TRUE)) library(NeurotypR)
})
```

## Parameters

```{r patient}
patient <- params$patient
test <- params$test
test_name <- params$test_name
# input_file_path <- file.path(file.choose())
input_file_path <- file.path(params$file)
```

## RAW SCORES

```{r}
test_name_prefix <- "RBANS Update Form A "

library(tidyverse)

df <- tryCatch(
  {
    suppressWarnings(
      readr::read_csv(
        input_file_path,
        col_names = FALSE,
        col_types = readr::cols(.default = "c"),
        show_col_types = FALSE,
        locale = readr::locale(encoding = "UTF-16LE"),
        skip_empty_rows = TRUE,
        trim_ws = TRUE,
        na = c("", "NA", "N/A", "-")
      )
    )
  },
  error = function(e) {
    # If read_csv fails, try with different encoding
    suppressWarnings(
      readr::read_csv(
        input_file_path,
        col_names = FALSE,
        col_types = readr::cols(.default = "c"),
        show_col_types = FALSE,
        skip_empty_rows = TRUE,
        trim_ws = TRUE,
        na = c("", "NA", "N/A", "-")
      )
    )
  }
)

# function
pluck_rbans_raw <- function(
    input_file_path,
    test_name_prefix,
    output_file_path = NULL) {
  df <- tryCatch(
    {
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          locale = readr::locale(encoding = "UTF-16LE"),
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    },
    error = function(e) {
      # If read_csv fails, try with different encoding
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    }
  )

  # Rename the columns
  names(df) <- c("Subtest", "NA", "Raw score")

  # Remove the second column
  df <- df |> select(Subtest, `Raw score`)

  # Find the start of the "Raw Score" section
  start_line <- which(df == "RAW SCORES") + 1

  # Find the stop of the "Raw Score" section
  stop_line <- which(df == "SCALED SCORES") - 1

  # Read from the "Raw Score" section
  df_raw <- df |>
    dplyr::slice(start_line:stop_line)

  # Keep only rows with the specified prefix in the first column
  df_raw <- df_raw |> filter(str_starts(Subtest, test_name_prefix))

  # Your new names stored in a character vector (ensure it matches the number of columns in `df`)
  vars <- c("scale", "raw_score")

  # Use `set_names()` to rename the columns
  df_raw <- df_raw |> set_names(vars)
  df_raw$scale <- as.character(df_raw$scale)
  df_raw$raw_score <- as.numeric(df_raw$raw_score)

  # Write the combined data to a CSV file
  write_csv(df_raw, output_file_path)

  return(df_raw)
}
# Define output file path for raw scores
output_file_path <- "data/processed_rbans_raw_data.csv"

# Run it
rbans_raw <- pluck_rbans_raw(
  input_file_path,
  test_name_prefix,
  output_file_path = output_file_path
)
```

## SCALED SCORES

```{r}
# input_file_path <- "data/004004907_3_10_2024.csv"
# test_name_prefix <- "RBANS Update Form A "
output_file_path <- "data/processed_rbans_scaled_data.csv"

# function
pluck_rbans_score <- function(
    input_file_path,
    test_name_prefix,
    output_file_path = NULL) {
  df <- tryCatch(
    {
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          locale = readr::locale(encoding = "UTF-16LE"),
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    },
    error = function(e) {
      # If read_csv fails, try with different encoding
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    }
  )

  # Rename the columns
  names(df) <- c("Subtest", "NA", "Scaled score")

  # Remove the second column
  df <- df |> select(Subtest, `Scaled score`)

  # Find the start of the "Raw Score" section
  start_line <- which(df == "SCALED SCORES") + 1

  # Find the stop of the "Raw Score" section
  stop_line <- which(df == "CONTEXTUAL EVENTS") - 1

  # Read from the "score" section
  df_score <- df |>
    dplyr::slice(start_line:stop_line)

  # Keep only rows with the specified prefix in the first column
  df_score <- df_score |> filter(str_starts(Subtest, test_name_prefix))

  # Your new names stored in a character vector (ensure it matches the number of columns in `df`)
  vars <- c("scale", "score")

  # Use `set_names()` to rename the columns
  df_score <- df_score |> set_names(vars)
  df_score$scale <- as.character(df_score$scale)
  df_score$score <- as.numeric(df_score$score)

  # Write the combined data to a CSV file
  write_csv(df_score, output_file_path)

  return(df_score)
}
rbans_score <- pluck_rbans_score(
  input_file_path,
  test_name_prefix,
  output_file_path = output_file_path
)
```

## SUBTEST COMPLETION TIMES

```{r}
output_file_path <- "data/processed_rbans_completion_time_data.csv"

# function
pluck_rbans_completion_times <- function(
    input_file_path,
    test_name_prefix,
    output_file_path = NULL) {
  df <- tryCatch(
    {
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          locale = readr::locale(encoding = "UTF-16LE"),
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    },
    error = function(e) {
      # If read_csv fails, try with different encoding
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    }
  )

  # Rename the columns
  names(df) <- c("Subtest", "NA", "Completion Time (seconds)")

  # Remove the second column
  df <- df |> select(Subtest, `Completion Time (seconds)`)

  # Find the start of the section
  start_line <- which(df == "SUBTEST COMPLETION TIMES") + 1

  # Find the stop of the section
  stop_line <- which(df == "RULES TRIGGERED") - 1

  # Read from the "Raw Score" section
  df_times <- df |>
    dplyr::slice(start_line:stop_line)

  # Keep only rows with the specified prefix in the first column
  df_times <- df_times |> filter(str_starts(Subtest, test_name_prefix))

  # Your new names stored in a character vector (ensure it matches the number of columns in `df`)
  vars <- c("scale", "completion_time_seconds")

  # Use `set_names()` to rename the columns
  df_times <- df_times |> set_names(vars)
  df_times$scale <- as.character(df_times$scale)
  df_times$completion_time_seconds <- as.numeric(
    df_times$completion_time_seconds
  )

  # Write the combined data to a CSV file
  write_csv(df_times, output_file_path)

  return(df_times)
}
rbans_time <- pluck_rbans_completion_times(
  input_file_path,
  test_name_prefix,
  output_file_path = output_file_path
)
```

## COMPOSITE SCORES

```{r}
output_file_path <- "data/processed_rbans_composite_data.csv"

# function
pluck_rbans_composite <- function(
    input_file_path,
    test_name_prefix,
    output_file_path = NULL) {
  df <- tryCatch(
    {
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          locale = readr::locale(encoding = "UTF-16LE"),
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    },
    error = function(e) {
      # If read_csv fails, try with different encoding
      suppressWarnings(
        readr::read_csv(
          input_file_path,
          col_names = FALSE,
          col_types = readr::cols(.default = "c"),
          show_col_types = FALSE,
          skip_empty_rows = TRUE,
          trim_ws = TRUE,
          na = c("", "NA", "N/A", "-")
        )
      )
    }
  )

  # Assume the first row after "Composite Score" has the column names
  start_line <- which(df$X1 == "Composite Score")
  # Assuming there's no specific end line, use the end of the file
  stop_line <- nrow(df)

  # Extracting the relevant section
  df_composite <- df |>
    slice((start_line + 1):stop_line) |>
    tidyr::separate(
      X3,
      sep = ",",
      into = c(
        "percentile",
        "ci_90_lo",
        "ci_90_up",
        "ci_95_lower",
        "ci_95_upper"
      )
    ) |>
    slice(-1) |>
    rename(scale = X1, score = X2) |>
    # Filter based on the prefix
    filter(str_starts(scale, test_name_prefix)) |>
    select(-c(ci_90_lo, ci_90_up)) |>
    mutate(
      scale = as.character(scale),
      score = as.numeric(score),
      percentile = as.numeric(percentile),
      ci_95_lower = as.numeric(ci_95_lower),
      ci_95_upper = as.numeric(ci_95_upper)
    )

  # Optionally write to a CSV file
  if (!is.null(output_file_path)) {
    write_csv(df_composite, output_file_path)
  }

  return(df_composite)
}

rbans_composite <- pluck_rbans_composite(
  input_file_path,
  test_name_prefix,
  output_file_path = output_file_path
)
```

## MERGE

```{r}
#' Process and Save RBANS Data
#'
#' This function processes RBANS raw, score, and composite data frames by joining them,
#' updating specific values, and saving the combined data to a CSV file.
#'
#' @param rbans_raw A data frame containing raw RBANS data.
#' @param rbans_score A data frame containing RBANS scores.
#' @param rbans_time A df containing completion times.
#' @param rbans_composite A data frame containing RBANS composite scores.
#' @param test_name_prefix A string representing the prefix to be removed from the scale names.
#' @param output_file_path A string specifying the path to save the combined CSV file.
#' @import dplyr
#' @import stringr
#' @export
process_and_save_rbans_data <- function(
    rbans_raw,
    rbans_score,
    rbans_time,
    rbans_composite,
    test_name_prefix,
    output_file_path) {
  library(dplyr)
  library(stringr)

  # Join the data into one dataframe by the test name
  df <- left_join(rbans_raw, rbans_score, by = "scale") |>
    mutate(percentile = as.numeric(""), range = as.character("")) |>
    left_join(rbans_time, by = "scale")

  # Update specific percentile values
  df$percentile[
    df$scale == "RBANS Update Form A Line Orientation"
  ] <- (params$line_orientation_pct_rank)
  df$percentile[
    df$scale == "RBANS Update Form A Picture Naming"
  ] <- (params$picture_naming_pct_rank)
  df$percentile[df$scale == "RBANS Update Form A List Recall"] <- (params$list_recall_pct_rank)
  df$percentile[
    df$scale == "RBANS Update Form A List Recognition"
  ] <- (params$list_recognition_pct_rank)

  # Recalculate percentiles based on score
  df <- df |>
    mutate(z = ifelse(!is.na(score), (score - 10) / 3, NA)) |>
    mutate(
      percentile = ifelse(is.na(percentile), trunc(pnorm(z) * 100), percentile)
    ) |>
    select(-z)

  # Merge with composite scores
  df <- bind_rows(df, rbans_composite) |>
    relocate(completion_time_seconds, .after = ci_95_upper)

  # Test score ranges (assuming NeurotypR::gpluck_make_score_ranges is a predefined function)
  df <- NeurotypR::gpluck_make_score_ranges(table = df, test_type = "npsych_test")

  # Remove prefix from scale names
  df <- df |>
    mutate(scale = str_remove(scale, test_name_prefix))

  scales_to_rename <- c(
    "Immediate Memory Index (IMI)" = "Immediate Memory Index",
    "Visuospatial/ Constructional Index (VCI)" = "Visuospatial/Constructional Index",
    "Language Index (LGI)" = "Language Index",
    "Attention Index (ATI)" = "Attention Index",
    "Delayed Memory Index (DRI)" = "Delayed Memory Index",
    "Total Scale (TOT)" = "RBANS Total Index"
  )

  df$scale <- map_chr(
    df$scale,
    ~ if_else(.x %in% names(scales_to_rename), scales_to_rename[.x], .x)
  )

  # Write the combined data to a CSV file
  return(write_csv(df, output_file_path))
}

df <- process_and_save_rbans_data(
  rbans_raw = rbans_raw,
  rbans_score = rbans_score,
  rbans_time = rbans_time,
  rbans_composite = rbans_composite,
  test_name_prefix = test_name_prefix,
  output_file_path = output_file_path
)

# Write the combined data to a CSV file
# output_file_path <- "data/rbans.csv"
# write_csv(df, output_file_path)
```

# MUTATE

```{r mutate}
rbans <- df

# Create ci_95 column if it doesn't exist
if (!("ci_95_lower" %in% names(rbans) && "ci_95_upper" %in% names(rbans))) {
  rbans$ci_95 <- NA_character_
} else {
  rbans$ci_95 <- ifelse(
    !is.na(rbans$ci_95_lower) & !is.na(rbans$ci_95_upper),
    paste0(rbans$ci_95_lower, "-", rbans$ci_95_upper),
    NA_character_
  )
}

rbans <- NeurotypR::gpluck_make_columns(
  data = rbans,
  test = params$test,
  test_name = params$test_name,
  ci_95 = rbans$ci_95,
  domain = "",
  subdomain = "",
  narrow = "",
  pass = "",
  verbal = "",
  timed = "",
  test_type = "npsych_test",
  score_type = "",
  description = "",
  result = ""
)
```

## Ensure scale column is character type

```{r ensure_scale_type}
# Ensure scale column is character type
if (!is.null(rbans$scale)) {
  rbans$scale <- as.character(rbans$scale)
  
  # Check for any list or complex objects in scale column
  if (any(sapply(rbans$scale, function(x) !is.atomic(x) || length(x) > 1))) {
    # Convert any problematic values to character
    rbans$scale <- sapply(rbans$scale, function(x) {
      if (!is.atomic(x) || length(x) > 1) {
        return(as.character(x)[1])
      } else {
        return(as.character(x))
      }
    })
  }
}
```

## Domain

```{r domain}
rbans <-
  rbans |>
  dplyr::mutate(
    domain = dplyr::case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "General Cognitive Ability",
      is.character(scale) & scale == "Immediate Memory Index" ~ "Memory",
      is.character(scale) & scale == "List Learning" ~ "Memory",
      is.character(scale) & scale == "Story Memory" ~ "Memory",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~
        "Visual Perception/Construction",
      is.character(scale) & scale == "Figure Copy" ~ "Visual Perception/Construction",
      is.character(scale) & scale == "Line Orientation" ~ "Visual Perception/Construction",
      is.character(scale) & scale == "Language Index" ~ "Verbal/Language",
      is.character(scale) & scale == "Picture Naming" ~ "Verbal/Language",
      is.character(scale) & scale == "Semantic Fluency" ~ "Verbal/Language",
      is.character(scale) & scale == "Attention Index" ~ "Attention/Executive",
      is.character(scale) & scale == "Digit Span" ~ "Attention/Executive",
      is.character(scale) & scale == "Coding" ~ "Attention/Executive",
      is.character(scale) & scale == "Delayed Memory Index" ~ "Memory",
      is.character(scale) & scale == "List Recall" ~ "Memory",
      is.character(scale) & scale == "List Recognition" ~ "Memory",
      is.character(scale) & scale == "Story Recall" ~ "Memory",
      is.character(scale) & scale == "Figure Recall" ~ "Memory",
      TRUE ~ as.character(domain)
    )
  )
```

## Subdomain

```{r}
rbans <-
  rbans |>
  dplyr::mutate(
    subdomain = dplyr::case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "Neuropsychological Functioning",
      is.character(scale) & scale == "Immediate Memory Index" ~ "Neuropsychological Functioning",
      is.character(scale) & scale == "List Learning" ~ "Learning Efficiency",
      is.character(scale) & scale == "Story Memory" ~ "Learning Efficiency",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~
        "Neuropsychological Functioning",
      is.character(scale) & scale == "Figure Copy" ~ "Organization",
      is.character(scale) & scale == "Line Orientation" ~ "Perception",
      is.character(scale) & scale == "Language Index" ~ "Neuropsychological Functioning",
      is.character(scale) & scale == "Picture Naming" ~ "Retrieval",
      is.character(scale) & scale == "Semantic Fluency" ~ "Fluency",
      is.character(scale) & scale == "Attention Index" ~ "Neuropsychological Functioning",
      is.character(scale) & scale == "Digit Span" ~ "Attention",
      is.character(scale) & scale == "Coding" ~ "Processing Speed",
      is.character(scale) & scale == "Delayed Memory Index" ~ "Neuropsychological Functioning",
      is.character(scale) & scale == "List Recall" ~ "Delayed Recall",
      is.character(scale) & scale == "List Recognition" ~ "Recognition Memory",
      is.character(scale) & scale == "Story Recall" ~ "Delayed Recall",
      is.character(scale) & scale == "Figure Recall" ~ "Delayed Recall",
      TRUE ~ as.character(subdomain)
    )
  )
```

## Narrow

```{r}
rbans <-
  rbans |>
  mutate(
    narrow = case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "RBANS Total Index",
      is.character(scale) & scale == "Immediate Memory Index" ~ "RBANS Memory Index",
      is.character(scale) & scale == "List Learning" ~ "Word-List Learning",
      is.character(scale) & scale == "Story Memory" ~ "Story Memory",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~
        "RBANS Visuospatial/Constructional Index",
      is.character(scale) & scale == "Figure Copy" ~ "Figure Copy",
      is.character(scale) & scale == "Line Orientation" ~ "Visual Perception",
      is.character(scale) & scale == "Language Index" ~ "RBANS Language Index",
      is.character(scale) & scale == "Picture Naming" ~ "Naming",
      is.character(scale) & scale == "Semantic Fluency" ~ "Semantic Fluency",
      is.character(scale) & scale == "Attention Index" ~ "RBANS Attention Index",
      is.character(scale) & scale == "Digit Span" ~ "Attention Span",
      is.character(scale) & scale == "Coding" ~ "Cognitive Efficiency",
      is.character(scale) & scale == "Delayed Memory Index" ~ "RBANS Memory Index",
      is.character(scale) & scale == "List Recall" ~ "Word-List Learning",
      is.character(scale) & scale == "List Recognition" ~ "Recognition Memory",
      is.character(scale) & scale == "Story Recall" ~ "Story Memory",
      is.character(scale) & scale == "Figure Recall" ~ "Visual Memory",
      TRUE ~ as.character(narrow)
    )
  )
```

## Timed/Untimed

```{r}
rbans <-
  rbans |>
  mutate(
    timed = case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "",
      is.character(scale) & scale == "Immediate Memory Index" ~ "Untimed",
      is.character(scale) & scale == "List Learning" ~ "Untimed",
      is.character(scale) & scale == "Story Memory" ~ "Untimed",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~ "Untimed",
      is.character(scale) & scale == "Figure Copy" ~ "Untimed",
      is.character(scale) & scale == "Line Orientation" ~ "Untimed",
      is.character(scale) & scale == "Language Index" ~ "",
      is.character(scale) & scale == "Picture Naming" ~ "Untimed",
      is.character(scale) & scale == "Semantic Fluency" ~ "Timed",
      is.character(scale) & scale == "Attention Index" ~ "",
      is.character(scale) & scale == "Digit Span" ~ "Untimed",
      is.character(scale) & scale == "Coding" ~ "Timed",
      is.character(scale) & scale == "Delayed Memory Index" ~ "Untimed",
      is.character(scale) & scale == "List Recall" ~ "Untimed",
      is.character(scale) & scale == "List Recognition" ~ "Untimed",
      is.character(scale) & scale == "Story Recall" ~ "Untimed",
      is.character(scale) & scale == "Figure Recall" ~ "Untimed",
      TRUE ~ as.character(timed)
    )
  )
```

## Verbal/Nonverbal

```{r}
rbans <-
  rbans |>
  mutate(
    verbal = case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "",
      is.character(scale) & scale == "Immediate Memory Index" ~ "Verbal",
      is.character(scale) & scale == "List Learning" ~ "Verbal",
      is.character(scale) & scale == "Story Memory" ~ "Verbal",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~ "Nonverbal",
      is.character(scale) & scale == "Figure Copy" ~ "Nonverbal",
      is.character(scale) & scale == "Line Orientation" ~ "Nonverbal",
      is.character(scale) & scale == "Language Index" ~ "Verbal",
      is.character(scale) & scale == "Picture Naming" ~ "Verbal",
      is.character(scale) & scale == "Semantic Fluency" ~ "Verbal",
      is.character(scale) & scale == "Attention Index" ~ "",
      is.character(scale) & scale == "Digit Span" ~ "Verbal",
      is.character(scale) & scale == "Coding" ~ "Nonverbal",
      is.character(scale) & scale == "Delayed Memory Index" ~ "",
      is.character(scale) & scale == "List Recall" ~ "Verbal",
      is.character(scale) & scale == "List Recognition" ~ "Verbal",
      is.character(scale) & scale == "Story Recall" ~ "Verbal",
      is.character(scale) & scale == "Figure Recall" ~ "Nonverbal",
      TRUE ~ as.character(verbal)
    )
  )
```

## PASS

```{r pass}
rbans <-
  rbans |>
  mutate(
    pass = case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "",
      is.character(scale) & scale == "Immediate Memory Index" ~ "Sequential",
      is.character(scale) & scale == "List Learning" ~ "Sequential",
      is.character(scale) & scale == "Story Memory" ~ "Sequential",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~ "Simultaneous",
      is.character(scale) & scale == "Figure Copy" ~ "Simultaneous",
      is.character(scale) & scale == "Line Orientation" ~ "Simultaneous",
      is.character(scale) & scale == "Language Index" ~ "Sequential",
      is.character(scale) & scale == "Picture Naming" ~ "Knowledge",
      is.character(scale) & scale == "Semantic Fluency" ~ "Sequential",
      is.character(scale) & scale == "Attention Index" ~ "Attention",
      is.character(scale) & scale == "Digit Span" ~ "Attention",
      is.character(scale) & scale == "Coding" ~ "Planning",
      is.character(scale) & scale == "Delayed Memory Index" ~ "",
      is.character(scale) & scale == "List Recall" ~ "Sequential",
      is.character(scale) & scale == "List Recognition" ~ "Sequential",
      is.character(scale) & scale == "Story Recall" ~ "Sequential",
      is.character(scale) & scale == "Figure Recall" ~ "Simultaneous",
      TRUE ~ as.character(pass)
    )
  )
```

## Score type

```{r score-type}
rbans <-
  rbans |>
  mutate(
    score_type = case_when(
      is.character(scale) & scale == "RBANS Total Index" ~ "standard_score",
      is.character(scale) & scale == "Immediate Memory Index" ~ "standard_score",
      is.character(scale) & scale == "List Learning" ~ "scaled_score",
      is.character(scale) & scale == "Story Memory" ~ "scaled_score",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~ "standard_score",
      is.character(scale) & scale == "Figure Copy" ~ "scaled_score",
      is.character(scale) & scale == "Line Orientation" ~ "percentile",
      is.character(scale) & scale == "Language Index" ~ "standard_score",
      is.character(scale) & scale == "Picture Naming" ~ "percentile",
      is.character(scale) & scale == "Semantic Fluency" ~ "scaled_score",
      is.character(scale) & scale == "Attention Index" ~ "standard_score",
      is.character(scale) & scale == "Digit Span" ~ "scaled_score",
      is.character(scale) & scale == "Coding" ~ "scaled_score",
      is.character(scale) & scale == "Delayed Memory Index" ~ "standard_score",
      is.character(scale) & scale == "List Recall" ~ "percentile",
      is.character(scale) & scale == "List Recognition" ~ "percentile",
      is.character(scale) & scale == "Story Recall" ~ "scaled_score",
      is.character(scale) & scale == "Figure Recall" ~ "scaled_score",
      TRUE ~ as.character(score_type)
    )
  )
```

## Descriptions

```{r}
rbans <-
  rbans |>
  mutate(
    description = case_when(
      is.character(scale) & scale == "RBANS Total Index" ~
        "composite indicator of general cognitive functioning",
      is.character(scale) & scale == "Immediate Memory Index" ~
        "composite verbal learning of a word list and a logical story",
      is.character(scale) & scale == "List Learning" ~ "word list learning",
      is.character(scale) & scale == "Story Memory" ~ "expository story learning",
      is.character(scale) & scale == "Visuospatial/Constructional Index" ~
        "broad visuospatial processing",
      is.character(scale) & scale == "Figure Copy" ~ "copy of a complex abstract figure",
      is.character(scale) & scale == "Line Orientation" ~ "basic perception of visual stimuli",
      is.character(scale) & scale == "Language Index" ~ "general language processing",
      is.character(scale) & scale == "Picture Naming" ~ "confrontation naming/expressive vocabulary",
      is.character(scale) & scale == "Semantic Fluency" ~ "semantic word fluency/generativity",
      is.character(scale) & scale == "Attention Index" ~
        "general attentional and executive functioning",
      is.character(scale) & scale == "Digit Span" ~ "attention span and auditory attention",
      is.character(scale) & scale == "Coding" ~ "speed of information processing",
      is.character(scale) & scale == "Delayed Memory Index" ~
        "long-term recall of verbal information",
      is.character(scale) & scale == "List Recall" ~ "long-term recall of a word list",
      is.character(scale) & scale == "List Recognition" ~ "delayed recognition of a word list",
      is.character(scale) & scale == "Story Recall" ~ "long-term recall of a detailed story",
      is.character(scale) & scale == "Figure Recall" ~
        "long-term recall and reconstruction of a complex abstract figure",
      TRUE ~ as.character(description)
    )
  )
```

## Glue results

```{r}
# Ensure all columns needed for glue are present and properly formatted
rbans <- rbans |>
  dplyr::mutate(
    scale = as.character(scale),
    description = as.character(description),
    range = if("range" %in% names(rbans)) as.character(range) else NA_character_
  )

# Create result strings using glue
rbans <-
  rbans |>
  dplyr::mutate(
    result = ifelse(
      !is.na(scale) & !is.na(description) & !is.na(range),
      glue::glue("{patient}'s score on {scale} ({description}) was {range}."),
      NA_character_
    )
  )
```

# EXPORT

```{r}
readr::write_excel_csv(
  rbans,
  here::here("data", "csv", "rbans.csv"),
  col_names = TRUE,
  na = ""
)
```

```{r}
cat("Finished!")
```
