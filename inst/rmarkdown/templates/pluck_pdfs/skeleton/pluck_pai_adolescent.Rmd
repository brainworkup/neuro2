---
title: "Import CSV file from PAI-Adolescent"
params:
  patient: "Ethan"
  test: pai_a
  test_name: "PAI-A"
  file:
    label: "Upload the PAI-A PDF file"
    value: file
    input: file
output:
  rmdformats::robobook:
    highlight: kate
---

## Setup

```{r setup, include = FALSE}
Sys.setenv(
  JAVA_HOME = "/Library/Java/JavaVirtualMachines/graalvm-jdk-22.0.1+8.1/Contents/Home"
)
options(java.parameters = "-Xmx16000m")
knitr::opts_chunk$set(
  root.dir = normalizePath("./"),
  echo = TRUE,
  message = TRUE,
  warning = FALSE,
  error = TRUE
)
library(dplyr)
library(fs)
library(glue)
library(here)
library(knitr)
library(magrittr)
library(pdftools)
library(readr)
library(rlang)
library(rmarkdown)
library(rmdformats)
library(shiny)
library(snakecase)
library(tabulapdf)
library(tibble)
library(tidyr)
library(vroom)
library(xfun)
library(yaml)
library(neuro2)
```

## Parameters

```{r}
file_path <- file.path(here::here("data-raw", "pdf", "pai_a.pdf"))
# read_content <- readLines(file_path)
```

```{r}
patient <- params$patient
test <- params$test
test_name <- params$test_name
# file_path <- file.path(file.choose())
file_path <- file.path(params$file)
saveRDS(file_path, "pai_a.rds")
# file_path <- readRDS("pai_adol.rds")
```

## Import PAI CSV file from PARiConnect

Need to export csv file from PARiConnect before processing.
"Export Client Data" tab, then click "Univ of Southern Cali" then "PAI".
Specify date range to exclude entire database.

```{r}
extracted_tables <- readr::read_csv(here::here(
  "data-raw",
  "pariconnectexportPAI-A.csv"
))
```

## PAI Clinical and validity scales

### Subset and rename columns

```{r}
df_validity <- extracted_tables |>
  dplyr::select(ICN_T:PIM_T) |>
  tidyr::gather() |>
  dplyr::rename(scale = key, score = value)

df_clinical <- extracted_tables |>
  dplyr::select(SOM_T:AGG_P_T) |>
  tidyr::gather() |>
  dplyr::rename(scale = key, score = value)
```

### Convert T scores to z scores to percentiles

```{r}
df_validity <- df_validity |>
  dplyr::mutate(z = (score - 50) / 10) |>
  dplyr::mutate(percentile = trunc(pnorm(z) * 100)) |>
  dplyr::select(scale, score, percentile)

df_clinical <- df_clinical |>
  dplyr::mutate(z = (score - 50) / 10) |>
  dplyr::mutate(percentile = trunc(pnorm(z) * 100)) |>
  dplyr::select(scale, score, percentile)
```

## Change scale names

```{r names}
# Validity Scales
df_validity[1, 1] <- c("Inconsistency")
df_validity[2, 1] <- c("Infrequency")
df_validity[3, 1] <- c("Negative Impression Management")
df_validity[4, 1] <- c("Positive Impression Management")
# Clinical Scales
df_clinical[1, 1] <- c("Somatic Complaints")
df_clinical[2, 1] <- c("Anxiety")
df_clinical[3, 1] <- c("Anxiety-Related Disorders")
df_clinical[4, 1] <- c("Depression")
df_clinical[5, 1] <- c("Mania")
df_clinical[6, 1] <- c("Paranoia")
df_clinical[7, 1] <- c("Schizophrenia")
df_clinical[8, 1] <- c("Borderline Features")
df_clinical[9, 1] <- c("Antisocial Features")
df_clinical[10, 1] <- c("Alcohol Problems")
df_clinical[11, 1] <- c("Drug Problems")
# Treatment consideration scales
df_clinical[12, 1] <- c("Aggression")
df_clinical[13, 1] <- c("Suicidal Ideation")
df_clinical[14, 1] <- c("Stress")
df_clinical[15, 1] <- c("Nonsupport")
df_clinical[16, 1] <- c("Treatment Rejection")
# Interpersonal scales
df_clinical[17, 1] <- c("Dominance")
df_clinical[18, 1] <- c("Warmth")
# Clinical subscales
df_clinical[19, 1] <- c("Conversion")
df_clinical[20, 1] <- c("Somatization")
df_clinical[21, 1] <- c("Health Concerns")
df_clinical[22, 1] <- c("Cognitive (A)")
df_clinical[23, 1] <- c("Affective (A)")
df_clinical[24, 1] <- c("Physiological (A)")
df_clinical[25, 1] <- c("Obsessive-Compulsive")
df_clinical[26, 1] <- c("Phobias")
df_clinical[27, 1] <- c("Traumatic Stress")
df_clinical[28, 1] <- c("Cognitive (D)")
df_clinical[29, 1] <- c("Affective (D)")
df_clinical[30, 1] <- c("Physiological (D)")
df_clinical[31, 1] <- c("Activity Level")
df_clinical[32, 1] <- c("Grandiosity")
df_clinical[33, 1] <- c("Irritability")
df_clinical[34, 1] <- c("Hypervigilance")
df_clinical[35, 1] <- c("Persecution")
df_clinical[36, 1] <- c("Resentment")
df_clinical[37, 1] <- c("Psychotic Experiences")
df_clinical[38, 1] <- c("Social Detachment")
df_clinical[39, 1] <- c("Thought Disorder")
df_clinical[40, 1] <- c("Affective Instability")
df_clinical[41, 1] <- c("Identity Problems")
df_clinical[42, 1] <- c("Negative Relationships")
df_clinical[43, 1] <- c("Self-Harm")
df_clinical[44, 1] <- c("Antisocial Behaviors")
df_clinical[45, 1] <- c("Egocentricity")
df_clinical[46, 1] <- c("Stimulus-Seeking")
df_clinical[47, 1] <- c("Aggressive Attitude")
df_clinical[48, 1] <- c("Verbal Aggression")
df_clinical[49, 1] <- c("Physical Aggression")
```

### Filter, group, select

```{r filter}
df_clinical <- df_clinical |>
  dplyr::slice(c(
    1,
    19:21,
    2,
    22:24,
    3,
    25:27,
    4,
    28:30,
    5,
    31:33,
    6,
    34:36,
    7,
    37:39,
    8,
    40:43,
    9,
    44:46,
    10:11,
    12,
    47:49,
    50:51,
    13:18
  ))
```

# Match with lookup table

```{r lookup}
# Load the lookup table
lookup_table <- readr::read_csv("~/Dropbox/neuropsych_lookup_table.csv")

# Merge the data with the lookup table
df_clinical_merged <- dplyr::mutate(df_clinical, test = test) |>
  dplyr::left_join(lookup_table, by = c("test" = "test", "scale" = "scale"))

# add missing columns
df_clinical_mutated <- neuro2::gpluck_make_columns(
  df_clinical_merged,
  ci_95 = "",
  range = "",
  result = ""
)

# Merge the data with the lookup table
df_validity_merged <- dplyr::mutate(df_validity, test = test) |>
  dplyr::left_join(lookup_table, by = c("test" = "test", "scale" = "scale"))

# add missing columns
df_validity_mutated <- neuro2::gpluck_make_columns(
  df_validity_merged,
  ci_95 = "",
  range = "",
  result = ""
)
```

## Test score ranges

```{r ranges}
gpluck_make_score_ranges <- function(
  table,
  score,
  percentile,
  range,
  test_type = c(
    "npsych_test",
    "rating_scale",
    "validity_indicator",
    "rating_scale_basc3"
  ),
  ...
) {
  # Collapse test_type to a single, valid value
  test_type <- match.arg(test_type)

  if (test_type == "npsych_test") {
    table <- table |>
      dplyr::mutate(
        range = dplyr::case_when(
          percentile >= 98 ~ "Exceptionally High",
          percentile %in% 91:97 ~ "Above Average",
          percentile %in% 75:90 ~ "High Average",
          percentile %in% 25:74 ~ "Average",
          percentile %in% 9:24 ~ "Low Average",
          percentile %in% 2:8 ~ "Below Average",
          percentile < 2 ~ "Exceptionally Low",
          TRUE ~ as.character(range)
        )
      )
  } else if (test_type == "rating_scale") {
    table <- table |>
      dplyr::mutate(
        range = dplyr::case_when(
          percentile >= 98 ~ "Exceptionally High",
          percentile %in% 91:97 ~ "Above Average",
          percentile %in% 75:90 ~ "High Average",
          percentile %in% 25:74 ~ "Average",
          percentile %in% 9:24 ~ "Low Average",
          percentile %in% 2:8 ~ "Below Average",
          percentile < 2 ~ "Exceptionally Low",
          TRUE ~ as.character(range)
        )
      )
  } else if (test_type == "validity_indicator") {
    table <- table |>
      dplyr::mutate(
        range = dplyr::case_when(
          percentile >= 25 ~ "WNL Score",
          percentile %in% 9:24 ~ "Low Average Score",
          percentile %in% 2:8 ~ "Below Average Score",
          percentile < 2 ~ "Exceptionally Low Score",
          TRUE ~ as.character(range)
        )
      )
  } else if (test_type == "rating_scale_basc3") {
    table <- table |>
      dplyr::mutate(
        range = dplyr::case_when(
          # Adaptive/Personal Adjustment (strengths flip)
          score >= 60 &
            subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Normative Strength",
          score %in%
            40:59 &
            subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Average",
          score %in%
            30:39 &
            subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "At-Risk",
          score %in%
            20:29 &
            subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Clinically Significant",
          score <= 20 &
            subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Markedly Impaired",

          # All other clinical subdomains (elevations = worse)
          score >= 80 &
            !subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Markedly Elevated",
          score %in%
            70:79 &
            !subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Clinically Significant",
          score %in%
            60:69 &
            !subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "At-Risk",
          score %in%
            40:59 &
            !subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Average",
          score <= 39 &
            !subdomain %in% c("Adaptive Skills", "Personal Adjustment") ~
            "Normative Strength",

          TRUE ~ as.character(range)
        )
      )
  }

  table
}

df_clinical <- df_clinical_mutated |>
  dplyr::mutate(range = NULL) |>
  gpluck_make_score_ranges(
    table = df_clinical_mutated,
    test_type = "rating_scale"
  ) |>
  dplyr::relocate(c(range), .after = percentile)

df_validity <- df_validity_mutated |>
  dplyr::mutate(range = NULL) |>
  gpluck_make_score_ranges(
    table = df_validity_mutated,
    test_type = "rating_scale"
  ) |>
  dplyr::relocate(c(range), .after = percentile)
```

## Glue results

```{r result}
df_clinical <- df_clinical |>
  dplyr::mutate(
    result = glue::glue(
      "{patient}'s score on {.data$scale} (i.e., {.data$description}) was {.data$range}."
    )
  )

df_validity <- df_validity |>
  dplyr::mutate(
    result = glue::glue(
      "{patient}'s score on {.data$scale} (i.e., {.data$description}) was {.data$range}."
    )
  )
```

# Finalize and save

## relocate variables

```{r}
df_clinical <- df_clinical |>
  dplyr::relocate(c(score, ci_95, percentile, range), .after = scale)

df_validity <- df_validity |>
  dplyr::relocate(c(score, ci_95, percentile, range), .after = scale)
```

## Write out final csv

```{r writeout}
readr::write_excel_csv(
  df_clinical,
  here::here("data-raw", "csv", "pai_a_clinical.csv"),
  col_names = TRUE,
  na = ""
)

readr::write_excel_csv(
  df_validity,
  here::here("data-raw", "csv", "pai_a_validity.csv"),
  col_names = TRUE,
  na = ""
)
```

## Text: extract, squish, save

Replace long spaces with a col break symbol.
Save text to markdown, quarto, and typst formats.

```{r text}
library(pdftools)
library(stringr)

# save file as path
file <- file.path(file_path)

get_text <- function(file) {
  txt <- pdftools::pdf_text(file) |> stringr::str_split("\n") |> unlist()
}
pai_text <- get_text(file)

pai_adol_text_squished <- stringr::str_replace_all(pai_text, "\\s{2,}", "- ") |>
  stringr::str_remove_all(",")
pai_adol_text_squished

# save
readr::write_lines(
  pai_adol_text_squished,
  here::here("pai_a_text_squished.md"),
  sep = "\n"
)
readr::write_lines(
  pai_adol_text_squished,
  here::here("pai_a_text_squished.txt"),
  sep = "\n"
)
```
