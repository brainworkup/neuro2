# Unified Neuropsychological Workflow Architecture

## Overview

This document outlines the architecture for a unified neuropsychological report generation workflow that combines the best features of the existing scripts while providing a clear, maintainable structure.

## Architecture Diagram

```
┌─────────────────────────────────────┐
│                                     │
   unified_neuropsych_workflow.sh     │◄────────┐
│     (Shell Script Entry Point)      │         │
│                                     │         │
└───────────────┬─────────────────────┘         │
                │                                │
                ▼                                │
┌─────────────────────────────────────┐         │
│                                     │         │
│      unified_workflow_runner.R      │         │
│      (Main Workflow Controller)     │         │
│                                     │         │
└───────────────┬─────────────────────┘         │
                │                                │
                ▼                                │
┌─────────────────────────────────────┐         │
│                                     │         │
│       setup_environment.R           │         │
│    (Environment & Dependencies)     │         │
│                                     │         │
└───────────────┬─────────────────────┘         │
                │                                │
                ▼                                │
┌─────────────────────────────────────┐         │
│                                     │         │
│      data_processor_module.R        │         │
│  (DuckDB + R6 Data Processing)      │         │
│                                     │         │
└───────────────┬─────────────────────┘         │
                │                                │
                ▼                                │
┌─────────────────────────────────────┐         │
│                                     │         │
│      domain_generator_module.R      │         │
│    (R6-based Domain Generation)     │         │
│                                     │         │
└───────────────┬─────────────────────┘         │
                │                                │
                ▼                                │
┌─────────────────────────────────────┐         │
│                                     │         │
│      report_generator_module.R      │         │
│    (Quarto Report Generation)       │         │
│                                     │         │
└───────────────┬─────────────────────┘         │
                │                                │
                ▼                                │
┌─────────────────────────────────────┐         │
│                                     │         │
│      new_patient_workflow.R         │─────────┘
│     (R Script Entry Point)          │
│                                     │
└─────────────────────────────────────┘
```

## Component Descriptions

### Entry Points

1. **neuropsych_workflow.sh**
   - Shell script entry point
   - Provides interactive command-line interface
   - Calls the unified_workflow_runner.R with appropriate parameters

2. **new_patient_workflow.R**
   - R script entry point
   - Provides programmatic interface for R users
   - Calls the unified_workflow_runner.R with appropriate parameters

### Core Components

3. **unified_workflow_runner.R**
   - Main workflow controller
   - Orchestrates the entire workflow
   - Calls each module in sequence
   - Handles configuration and parameters

4. **setup_environment.R**
   - Checks and installs required packages
   - Verifies R6 class files
   - Creates necessary directories
   - Sets up utility functions

5. **data_processor_module.R**
   - Handles data loading and processing
   - Uses DuckDB for efficient data operations
   - Converts CSV to optimized formats (Parquet/Arrow)
   - Implements R6 classes for data processing

6. **domain_generator_module.R**
   - Generates domain-specific QMD files
   - Uses R6 classes for domain processing
   - Creates visualizations and tables

7. **report_generator_module.R**
   - Renders the final report using Quarto
   - Handles template management
   - Supports multiple output formats (PDF, HTML)

## Data Flow

1. User invokes either entry point script
2. Entry point calls unified_workflow_runner.R
3. unified_workflow_runner.R calls setup_environment.R
4. Data is processed by data_processor_module.R
5. Domain files are generated by domain_generator_module.R
6. Final report is rendered by report_generator_module.R

## Technology Stack

- **R6 Classes**: Used throughout for efficient object-oriented programming
- **DuckDB**: Used for efficient data processing and querying
- **Parquet/Arrow**: Used for optimized data storage
- **Quarto**: Used for report generation

## Configuration

A unified configuration approach using YAML:

```yaml
# config.yml
patient:
  name: "Patient Name"
  age: 35
  doe: "2025-07-01"

data:
  input_dir: "data-raw/csv"
  output_dir: "data"
  format: "parquet"  # Options: csv, parquet, arrow, all

processing:
  use_duckdb: true
  parallel: true
  
report:
  template: "template.qmd"
  format: "typst-pdf"  # Options: typst-pdf, html
  output_dir: "output"
```

## Benefits of Unified Architecture

1. **Single Source of Truth**: One main workflow controller
2. **Clear Dependencies**: Well-defined module relationships
3. **Consistent Technology**: R6 and DuckDB used throughout
4. **Flexible Entry Points**: Both shell and R interfaces
5. **Modular Design**: Easy to maintain and extend
6. **Performance Optimized**: Uses modern data processing techniques
7. **Configurable**: Unified configuration approach
