## Verbal/Language {#sec-verbal}

{{< include _02-03_verbal_text.qmd >}}

```{r}
#| label: setup-verbal
#| include: false

# Source R6 classes
source("R/DomainProcessorR6.R")
source("R/NeuropsychResultsR6.R")
source("R/DotplotR6.R")
source("R/TableGT.R")
source("R/duckdb_neuropsych_loader.R")

# Load libraries
library(duckdb)
library(DBI)
library(arrow)

# Filter by domain
domains <- c("Verbal/Language")

# Target phenotype
pheno <- "verbal"

# Method 1: Query from Parquet using DuckDB
con <- DBI::dbConnect(duckdb::duckdb())

# Query verbal domain data directly from parquet
verbal <- DBI::dbGetQuery(
  con,
  "SELECT * FROM read_parquet('data/neurocog.parquet') 
   WHERE domain = 'Verbal/Language'"
)

DBI::dbDisconnect(con, shutdown = TRUE)

# Create R6 processor with injected data
processor_verbal <- DomainProcessorR6$new(
  domains = domains,
  pheno = pheno,
  input_file = NULL # No file needed - data injected
)

# Inject the queried data
processor_verbal$data <- verbal

# Process the data (no need to load_data since we injected it)
processor_verbal$filter_by_domain()
```

```{r}
#| label: export-verbal
#| include: false
#| eval: true

# Process and export data using R6
processor_verbal$select_columns()
processor_verbal$save_data()

# Update the original object
verbal <- processor_verbal$data
```

```{r}
#| label: data-verbal
#| include: false
#| eval: true

# Use all data for this domain
data_verbal <- verbal
```

```{r}
#| label: text-verbal
#| cache: true
#| include: false

# Generate text using R6 class
results_processor <- NeuropsychResultsR6$new(
  data = data_verbal,
  file = "_02-03_verbal_text.qmd"
)
results_processor$process()
```

```{r}
#| label: qtbl-verbal
#| dev: tikz
#| fig-process: pdf2png
#| include: false
#| eval: true

# Set the default engine for tikz
options(tikzDefaultEngine = "xetex")

# Table parameters
table_name <- "table_verbal"
vertical_padding <- 0
multiline <- TRUE

# Create table using TableGT R6 class
table_gt <- TableGT$new(
  data = data_verbal,
  pheno = pheno,
  table_name = table_name,
  vertical_padding = vertical_padding,
  source_note = "Standard score: Mean = 100 [50th‰], SD ± 15 [16th‰, 84th‰]",
  multiline = multiline
)

# Build and save the table
table_gt$build_table()
```

```{r}
#| label: fig-verbal-subdomain
#| include: false
#| eval: true

# Create subdomain plot using R6 DotplotR6
dotplot_subdomain <- DotplotR6$new(
  data = data_verbal,
  x = "z_mean_subdomain",
  y = "subdomain",
  filename = "fig_verbal_subdomain.svg"
)
dotplot_subdomain$create_plot()
```

```{=typst}
// Define a function to create a domain with a title, a table, and a figure
#let domain(title: none, file_qtbl, file_fig) = {
  let font = (font: "Roboto Slab", size: 0.7em)
  set text(..font)
  pad(top: 0.5em)[]
  grid(
    columns: (50%, 50%),
    gutter: 8pt,
    figure(
      [#image(file_qtbl)],
      caption: figure.caption(position: top, [#title]),
      kind: "qtbl",
      supplement: [*Table*],
    ),
    figure(
      [#image(file_fig, width: auto)],
      caption: figure.caption(
        position: bottom,
        [Performance across cognitive domains. #footnote[All scores in these figures have been standardized as z-scores.]],
      ),
      placement: none,
      kind: "image",
      supplement: [*Figure*],
      gap: 0.5em,
    ),
  )
}
```

```{=typst}
// Define the title of the domain
#let title = "Verbal/Language"

// Define the file name of the table
#let file_qtbl = "table_verbal.png"

// Define the file name of the figure
#let file_fig = "fig_verbal_subdomain.svg"

// The title is appended with ' Scores'
#domain(title: [#title Scores], file_qtbl, file_fig)
