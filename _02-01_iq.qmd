## General Cognitive Ability {#sec-iq}

{{< include _02-01_iq_text.qmd >}}

```{r}
#| label: setup-iq
#| include: false

# Source R6 classes
source("R/DomainProcessorR6.R")
source("R/NeuropsychResultsR6.R")
source("R/DotplotR6.R")

# Filter by domain
domains <- c("General Cognitive Ability")

# Target phenotype
pheno <- "iq"

# Create R6 processor
processor_iq <- DomainProcessorR6$new(
  domains = domains,
  pheno = pheno,
  input_file = "data/neurocog.csv"
)

# Load and process data
processor_iq$load_data()
processor_iq$filter_by_domain()

# Create the data object with original name for compatibility
iq <- processor_iq$data
```

```{r}
#| label: export-iq
#| include: false
#| eval: true

# Process and export data using R6
processor_iq$select_columns()
processor_iq$save_data()

# Update the original object
iq <- processor_iq$data
```

```{r}
#| label: data-iq
#| include: false
#| eval: true

# Define the scales of interest
scales <- c(
  "Auditory Working Memory (AWMI)",
  "Cognitive Proficiency (CPI)",
  "Crystallized Knowledge",
  "Fluid Reasoning (FRI)",
  "Fluid Reasoning",
  "Full Scale (FSIQ)",
  "Full Scale IQ (FSIQ)",
  "General Ability (GAI)",
  "General Ability",
  "General Intelligence",
  "Global Neurocognitive Index (G)",
  "NAB Attention Index",
  "NAB Executive Functions Index",
  "NAB Language Index",
  "NAB Memory Index",
  "NAB Spatial Index",
  "NAB Total Index",
  "Nonverbal (NVI)",
  "Perceptual Reasoning (PRI)",
  "Perceptual Reasoning",
  "Processing Speed (PSI)",
  "Processing Speed",
  "RBANS Total Index",
  "Test of Premorbid Functioning",
  "TOPF Standard Score",
  "Total NAB Index (T-NAB)",
  "Verbal Comprehension (VCI)",
  "Verbal Comprehension",
  "Visual Perception/Construction",
  "Visual Spatial (VSI)",
  "Vocabulary Acquisition (VAI)",
  "Word Reading",
  "Working Memory (WMI)",
  "Working Memory",
  "Attention Index (ATT)",
  "Language Index (LAN)",
  "Spatial Index (SPT)",
  "Memory Index (MEM)",
  "Executive Functions Index (EXE)"
)

# Filter the data using NeurotypR
data_iq <- NeurotypR::filter_data(
  data = iq,
  domain = domains,
  scale = scales
)
```

```{r}
#| label: text-iq
#| cache: true
#| include: false

# Generate text using R6 class
results_processor <- NeuropsychResultsR6$new(
  data = data_iq,
  file = "_02-01_iq_text.qmd"
)
results_processor$process()
```

```{r}
#| label: qtbl-iq
#| dev: tikz
#| fig-process: pdf2png
#| include: false
#| eval: true

# Set the default engine for tikz
options(tikzDefaultEngine = "xetex")

# Table parameters
table_name <- "table_iq"
vertical_padding <- 0
multiline <- TRUE

# Create table using NeurotypR
NeurotypR::tbl_gt(
  data = data_iq,
  pheno = pheno,
  table_name = table_name,
  vertical_padding = vertical_padding,
  source_note = "Standard score: Mean = 100 [50th‰], SD ± 15 [16th‰, 84th‰]",
  multiline = multiline
)
```

```{r}
#| label: fig-iq-subdomain
#| include: false
#| eval: true

# Create subdomain plot using R6 DotplotR6
dotplot_subdomain <- DotplotR6$new(
  data = data_iq,
  x = "z_mean_subdomain",
  y = "subdomain",
  filename = "fig_iq_subdomain.svg"
)
dotplot_subdomain$create_plot()
```

```{r}
#| label: fig-iq-narrow
#| include: false

# Create narrow plot using R6 DotplotR6
dotplot_narrow <- DotplotR6$new(
  data = data_iq,
  x = "z_mean_narrow",
  y = "narrow",
  filename = "fig_iq_narrow.svg"
)
dotplot_narrow$create_plot()
```

```{=typst}
// Define a function to create a domain with a title, a table, and a figure
#let domain(title: none, file_qtbl, file_fig) = {
  let font = (font: "Roboto Slab", size: 0.7em)
  set text(..font)
  pad(top: 0.5em)[]
  grid(
    columns: (50%, 50%),
    gutter: 8pt,
    figure(
      [#image(file_qtbl)],
      caption: figure.caption(position: top, [#title]),
      kind: "qtbl",
      supplement: [*Table*],
    ),
    figure(
      [#image(file_fig, width: auto)],
      caption: figure.caption(
        position: bottom,
        [Performance across cognitive domains. #footnote[All scores in these figures have been standardized as z-scores.]],
      ),
      placement: none,
      kind: "image",
      supplement: [*Figure*],
      gap: 0.5em,
    ),
  )
}
```
```{=typst}
// Define the title of the domain
#let title = "General Cognitive Ability"

// Define the file name of the table
#let file_qtbl = "table_iq.png"

// Define the file name of the figure
#let file_fig = "fig_iq_subdomain.svg"

// The title is appended with ' Scores'
#domain(title: [#title Scores], file_qtbl, file_fig)
```
